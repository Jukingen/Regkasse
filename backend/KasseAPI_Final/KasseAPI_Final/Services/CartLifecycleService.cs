using KasseAPI_Final.Data;
using KasseAPI_Final.Models;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace KasseAPI_Final.Services
{
    /// <summary>
    /// Akƒ±llƒ± Sepet Ya≈üam D√∂ng√ºs√º Y√∂netimi
    /// - Otomatik sepet temizleme (session expire)
    /// - Kullanƒ±cƒ±ya √∂zel sepet y√∂netimi
    /// - Database temizliƒüi
    /// </summary>
    public class CartLifecycleService : BackgroundService
    {
        private readonly IServiceProvider _serviceProvider;
        private readonly ILogger<CartLifecycleService> _logger;
        private readonly TimeSpan _checkInterval = TimeSpan.FromMinutes(1); // 1 dakikada bir kontrol (15 dakika + gece 00:00 i√ßin)

        public CartLifecycleService(
            IServiceProvider serviceProvider,
            ILogger<CartLifecycleService> logger)
        {
            _serviceProvider = serviceProvider;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("üöÄ CartLifecycleService ba≈ülatƒ±ldƒ± - Akƒ±llƒ± sepet y√∂netimi aktif");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    await CleanupExpiredCarts();
                    await CleanupOrphanedCarts();
                    await CleanupCartsByTimeRules(); // 15 dakika + gece 00:00 kontrol√º
                    await LogCartStatistics();
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "‚ùå CartLifecycleService hatasƒ±");
                }

                await Task.Delay(_checkInterval, stoppingToken);
            }
        }

        /// <summary>
        /// S√ºresi dolmu≈ü sepetleri temizle
        /// </summary>
        private async Task CleanupExpiredCarts()
        {
            using var scope = _serviceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            try
            {
                // üîí G√úVENLƒ∞K: Sadece s√ºresi dolmu≈ü aktif sepetleri bul
                var expiredCarts = await context.Carts
                    .Include(c => c.Items)
                    .Where(c => c.ExpiresAt < DateTime.UtcNow && 
                               c.Status == CartStatus.Active)
                    .Select(c => new { c.CartId, c.UserId, c.TableNumber, c.Items.Count })
                    .ToListAsync();

                if (expiredCarts.Any())
                {
                    _logger.LogInformation("üßπ {ExpiredCartsCount} s√ºresi dolmu≈ü sepet bulundu, temizleniyor...", 
                        expiredCarts.Count);
                    
                    // Batch delete i√ßin ID'leri topla
                    var cartIds = expiredCarts.Select(c => c.CartId).ToList();
                    
                    // √ñnce CartItems'larƒ± sil
                    var cartItemsToDelete = await context.CartItems
                        .Where(ci => cartIds.Contains(ci.CartId))
                        .ToListAsync();
                    
                    if (cartItemsToDelete.Any())
                    {
                        context.CartItems.RemoveRange(cartItemsToDelete);
                        _logger.LogInformation("üßπ {ItemsCount} sepet √ºr√ºn√º silindi", cartItemsToDelete.Count);
                    }
                    
                    // Sonra Cart'larƒ± sil
                    var cartsToDelete = await context.Carts
                        .Where(c => cartIds.Contains(c.CartId))
                        .ToListAsync();
                    
                    context.Carts.RemoveRange(cartsToDelete);
                    
                    // Deƒüi≈üiklikleri kaydet
                    var deletedCount = await context.SaveChangesAsync();
                    
                    _logger.LogInformation("‚úÖ {ExpiredCartsCount} s√ºresi dolmu≈ü sepet temizlendi, {DeletedCount} kayƒ±t silindi", 
                        expiredCarts.Count, deletedCount);
                    
                    // G√ºvenlik log'u
                    foreach (var cart in expiredCarts)
                    {
                        _logger.LogInformation("üóëÔ∏è Expired cart cleaned: CartId={CartId}, UserId={UserId}, TableNumber={TableNumber}, ItemsCount={ItemsCount}", 
                            cart.CartId, cart.UserId, cart.TableNumber, cart.Count);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå S√ºresi dolmu≈ü sepet temizleme hatasƒ±");
            }
        }

        /// <summary>
        /// Kullanƒ±cƒ±sƒ± olmayan (orphaned) sepetleri temizle
        /// </summary>
        private async Task CleanupOrphanedCarts()
        {
            using var scope = _serviceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            try
            {
                // üîí G√úVENLƒ∞K: UserId olmayan veya ge√ßersiz UserId'li sepetleri bul
                var orphanedCarts = await context.Carts
                    .Include(c => c.Items)
                    .Where(c => string.IsNullOrEmpty(c.UserId) || 
                               !context.Users.Any(u => u.Id == c.UserId))
                    .Select(c => new { c.CartId, c.UserId, c.TableNumber, c.Items.Count })
                    .ToListAsync();

                if (orphanedCarts.Any())
                {
                    _logger.LogWarning("‚ö†Ô∏è {OrphanedCartsCount} kullanƒ±cƒ±sƒ±z sepet bulundu, g√ºvenlik i√ßin temizleniyor...", 
                        orphanedCarts.Count);
                    
                    // Batch delete i√ßin ID'leri topla
                    var cartIds = orphanedCarts.Select(c => c.CartId).ToList();
                    
                    // √ñnce CartItems'larƒ± sil
                    var cartItemsToDelete = await context.CartItems
                        .Where(ci => cartIds.Contains(ci.CartId))
                        .ToListAsync();
                    
                    if (cartItemsToDelete.Any())
                    {
                        context.CartItems.RemoveRange(cartItemsToDelete);
                        _logger.LogInformation("üßπ {ItemsCount} kullanƒ±cƒ±sƒ±z sepet √ºr√ºn√º silindi", cartItemsToDelete.Count);
                    }
                    
                    // Sonra Cart'larƒ± sil
                    var cartsToDelete = await context.Carts
                        .Where(c => cartIds.Contains(c.CartId))
                        .ToListAsync();
                    
                    context.Carts.RemoveRange(cartsToDelete);
                    
                    // Deƒüi≈üiklikleri kaydet
                    var deletedCount = await context.SaveChangesAsync();
                    
                    _logger.LogInformation("‚úÖ {OrphanedCartsCount} kullanƒ±cƒ±sƒ±z sepet temizlendi, {DeletedCount} kayƒ±t silindi", 
                        orphanedCarts.Count, deletedCount);
                    
                    // G√ºvenlik log'u
                    foreach (var cart in orphanedCarts)
                    {
                        _logger.LogWarning("‚ö†Ô∏è Orphaned cart cleaned: CartId={CartId}, UserId={UserId}, TableNumber={TableNumber}, ItemsCount={ItemsCount}", 
                            cart.CartId, cart.UserId ?? "NULL", cart.TableNumber, cart.Count);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå Kullanƒ±cƒ±sƒ±z sepet temizleme hatasƒ±");
            }
        }

        /// <summary>
        /// Zaman kurallarƒ±na g√∂re sepet temizleme (15 dakika + gece 00:00)
        /// </summary>
        private async Task CleanupCartsByTimeRules()
        {
            using var scope = _serviceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            try
            {
                var now = DateTime.UtcNow;
                var currentHour = now.Hour;
                var currentMinute = now.Minute;

                // üåô Gece 00:00 kontrol√º - T√ºm aktif sepetleri temizle
                if (currentHour == 0 && currentMinute == 0)
                {
                    _logger.LogInformation("üåô Gece 00:00 - T√ºm aktif sepetler otomatik sƒ±fƒ±rlanƒ±yor...");
                    
                    var allActiveCarts = await context.Carts
                        .Include(c => c.Items)
                        .Where(c => c.Status == CartStatus.Active)
                        .Select(c => new { c.CartId, c.UserId, c.TableNumber, c.Items.Count })
                        .ToListAsync();

                    if (allActiveCarts.Any())
                    {
                        _logger.LogInformation("üßπ {ActiveCartsCount} aktif sepet bulundu, gece 00:00 temizliƒüi yapƒ±lƒ±yor...", 
                            allActiveCarts.Count);

                        // √ñnce CartItems'larƒ± sil
                        var cartItemsToDelete = await context.CartItems
                            .Where(ci => context.Carts
                                .Where(c => c.Status == CartStatus.Active)
                                .Select(c => c.CartId)
                                .Contains(ci.CartId))
                            .ToListAsync();

                        if (cartItemsToDelete.Any())
                        {
                            context.CartItems.RemoveRange(cartItemsToDelete);
                            _logger.LogInformation("üßπ {ItemsCount} sepet √ºr√ºn√º silindi (gece 00:00)", cartItemsToDelete.Count);
                        }

                        // Sonra Cart'larƒ± sil
                        var cartsToDelete = await context.Carts
                            .Where(c => c.Status == CartStatus.Active)
                            .ToListAsync();

                        context.Carts.RemoveRange(cartsToDelete);

                        // Deƒüi≈üiklikleri kaydet
                        var deletedCount = await context.SaveChangesAsync();
                        
                        _logger.LogInformation("‚úÖ Gece 00:00 temizliƒüi tamamlandƒ±: {CartsCount} sepet, {ItemsCount} √ºr√ºn silindi", 
                            cartsToDelete.Count, cartItemsToDelete.Count);
                    }
                    else
                    {
                        _logger.LogInformation("‚ÑπÔ∏è Gece 00:00 - Temizlenecek aktif sepet bulunamadƒ±");
                    }
                    
                    return; // Gece 00:00 i≈ülemi yapƒ±ldƒ±ysa diƒüer kontrolleri atla
                }

                // ‚è∞ 15 dakika kontrol√º - Her sepet i√ßin olu≈üturulma zamanƒ±ndan 15 dakika ge√ßtiyse temizle
                var fifteenMinutesAgo = now.AddMinutes(-15);
                
                var expiredByTimeRule = await context.Carts
                    .Include(c => c.Items)
                    .Where(c => c.Status == CartStatus.Active && 
                               c.CreatedAt < fifteenMinutesAgo)
                    .Select(c => new { c.CartId, c.UserId, c.TableNumber, c.Items.Count, c.CreatedAt })
                    .ToListAsync();

                if (expiredByTimeRule.Any())
                {
                    _logger.LogInformation("‚è∞ {ExpiredCartsCount} sepet 15 dakika kuralƒ±na g√∂re s√ºresi doldu, temizleniyor...", 
                        expiredByTimeRule.Count);

                    // Batch delete i√ßin ID'leri topla
                    var cartIds = expiredByTimeRule.Select(c => c.CartId).ToList();

                    // √ñnce CartItems'larƒ± sil
                    var cartItemsToDelete = await context.CartItems
                        .Where(ci => cartIds.Contains(ci.CartId))
                        .ToListAsync();

                    if (cartItemsToDelete.Any())
                    {
                        context.CartItems.RemoveRange(cartItemsToDelete);
                        _logger.LogInformation("üßπ {ItemsCount} sepet √ºr√ºn√º silindi (15 dakika kuralƒ±)", cartItemsToDelete.Count);
                    }

                    // Sonra Cart'larƒ± sil
                    var cartsToDelete = await context.Carts
                        .Where(c => cartIds.Contains(c.CartId))
                        .ToListAsync();

                    context.Carts.RemoveRange(cartsToDelete);

                    // Deƒüi≈üiklikleri kaydet
                    var deletedCount = await context.SaveChangesAsync();

                    _logger.LogInformation("‚úÖ 15 dakika kuralƒ± temizliƒüi tamamlandƒ±: {CartsCount} sepet, {ItemsCount} √ºr√ºn silindi", 
                        cartsToDelete.Count, cartItemsToDelete.Count);

                    // Detaylƒ± log
                    foreach (var cart in expiredByTimeRule)
                    {
                        var timeDiff = now - cart.CreatedAt;
                        var minutesDiff = (int)timeDiff.TotalMinutes;
                        _logger.LogInformation("‚è∞ Masa {TableNumber} sepeti {MinutesDiff} dakika ge√ßti, sƒ±fƒ±rlandƒ± (UserId: {UserId})", 
                            cart.TableNumber, minutesDiff, cart.UserId);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå CleanupCartsByTimeRules hatasƒ±");
            }
        }

        /// <summary>
        /// Sepet istatistiklerini logla
        /// </summary>
        private async Task LogCartStatistics()
        {
            using var scope = _serviceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            try
            {
                var stats = await context.Carts
                    .GroupBy(c => c.Status)
                    .Select(g => new { Status = g.Key, Count = g.Count() })
                    .ToListAsync();

                var totalItems = await context.CartItems.CountAsync();
                var activeUsers = await context.Carts
                    .Where(c => c.Status == CartStatus.Active)
                    .Select(c => c.UserId)
                    .Distinct()
                    .CountAsync();

                _logger.LogInformation("üìä Sepet ƒ∞statistikleri - Aktif: {Active}, Tamamlanan: {Completed}, Toplam √úr√ºn: {TotalItems}, Aktif Kullanƒ±cƒ±: {ActiveUsers}", 
                    stats.FirstOrDefault(s => s.Status == CartStatus.Active)?.Count ?? 0,
                    stats.FirstOrDefault(s => s.Status == CartStatus.Completed)?.Count ?? 0,
                    totalItems,
                    activeUsers);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå Sepet istatistikleri loglama hatasƒ±");
            }
        }

        /// <summary>
        /// Manuel sepet temizleme (logout sƒ±rasƒ±nda √ßaƒürƒ±lƒ±r)
        /// </summary>
        public async Task CleanupUserCarts(string userId)
        {
            using var scope = _serviceProvider.CreateScope();
            var context = scope.ServiceProvider.GetRequiredService<AppDbContext>();

            try
            {
                _logger.LogInformation("üßπ Kullanƒ±cƒ± {UserId} i√ßin sepet temizleme ba≈ülatƒ±ldƒ±", userId);
                
                // Transaction kullanarak g√ºvenli silme i≈ülemi
                using var transaction = await context.Database.BeginTransactionAsync();
                
                try
                {
                    // üîí G√úVENLƒ∞K: Sadece belirtilen kullanƒ±cƒ±nƒ±n aktif sepetlerini bul
                    var userCarts = await context.Carts
                        .Include(c => c.Items)
                        .Where(c => c.UserId == userId && 
                                   c.Status == CartStatus.Active)
                        .Select(c => new { c.CartId, c.TableNumber, c.Items.Count })
                        .ToListAsync();

                    if (userCarts.Any())
                    {
                        _logger.LogInformation("üßπ Kullanƒ±cƒ± {UserId} i√ßin {CartsCount} aktif sepet bulundu, temizleniyor...", 
                            userId, userCarts.Count);
                        
                        // Batch delete i√ßin ID'leri topla
                        var cartIds = userCarts.Select(c => c.CartId).ToList();
                        
                        // √ñnce CartItems'larƒ± sil
                        var cartItemsToDelete = await context.CartItems
                            .Where(ci => cartIds.Contains(ci.CartId))
                            .ToListAsync();
                        
                        if (cartItemsToDelete.Any())
                        {
                            context.CartItems.RemoveRange(cartItemsToDelete);
                            _logger.LogInformation("üßπ Kullanƒ±cƒ± {UserId} i√ßin {ItemsCount} sepet √ºr√ºn√º silindi", 
                                cartItemsToDelete.Count);
                        }
                        
                        // Sonra Cart'larƒ± sil
                        var cartsToDelete = await context.Carts
                            .Where(c => cartIds.Contains(c.CartId))
                            .ToListAsync();
                        
                        context.Carts.RemoveRange(cartsToDelete);
                        
                        // Deƒüi≈üiklikleri kaydet
                        var deletedCount = await context.SaveChangesAsync();
                        
                        // Transaction'ƒ± commit et
                        await transaction.CommitAsync();
                        
                        _logger.LogInformation("‚úÖ Kullanƒ±cƒ± {UserId} i√ßin {CartsCount} sepet temizlendi, {DeletedCount} kayƒ±t silindi", 
                            userCarts.Count, deletedCount);
                        
                        // G√ºvenlik log'u
                        foreach (var cart in userCarts)
                        {
                            _logger.LogInformation("üóëÔ∏è User cart cleaned: CartId={CartId}, UserId={UserId}, TableNumber={TableNumber}, ItemsCount={ItemsCount}", 
                                cart.CartId, userId, cart.TableNumber, cart.Count);
                        }
                    }
                    else
                    {
                        _logger.LogInformation("‚ÑπÔ∏è Kullanƒ±cƒ± {UserId} i√ßin aktif sepet bulunamadƒ±", userId);
                        // Transaction'ƒ± commit et (hi√ßbir deƒüi≈üiklik yok)
                        await transaction.CommitAsync();
                    }
                }
                catch (Exception ex)
                {
                    // Hata durumunda transaction'ƒ± rollback et
                    await transaction.RollbackAsync();
                    _logger.LogError(ex, "‚ùå Transaction hatasƒ±, rollback yapƒ±ldƒ±: {UserId}", userId);
                    throw; // Hatayƒ± yukarƒ± fƒ±rlat
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "‚ùå Kullanƒ±cƒ± sepet temizleme hatasƒ±: {UserId}. Exception: {ExceptionType}, Message: {ExceptionMessage}", 
                    userId, ex.GetType().Name, ex.Message);
                throw; // Hatayƒ± yukarƒ± fƒ±rlat
            }
        }
    }
}
